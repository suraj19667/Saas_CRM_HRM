{% extends 'base.html' %}
{% load humanize %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #E5E7EB;
    }

    .stat-card h3 {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 8px 0;
        color: #111827;
    }

    .stat-card p {
        font-size: 14px;
        color: #6B7280;
        margin: 0;
    }

    .stat-card .trend {
        font-size: 12px;
        color: #10B981;
        margin-top: 8px;
    }

    .chart-container {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #E5E7EB;
        margin-bottom: 24px;
    }

    .activity-item {
        padding: 12px;
        border-bottom: 1px solid #F3F4F6;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .badge-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-active {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-trial {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .badge-suspended {
        background: #FEE2E2;
        color: #991B1B;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <h1 style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0;">Dashboard</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb" style="margin: 0; padding: 0; background: none;">
            <li class="breadcrumb-item"><a href="{% url 'saas_dashboard' %}">Dashboard</a></li>
        </ol>
    </nav>
</div>

<!-- Metrics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ total_companies|intcomma }}</h3>
            <p>Total Companies</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ active_subscriptions|intcomma }}</h3>
            <p>Active Subscriptions</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>₹{{ monthly_revenue|floatformat:0|intcomma }}</h3>
            <p>Monthly Revenue</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ active_trials|intcomma }}</h3>
            <p>Active Trials</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ suspended_accounts|intcomma }}</h3>
            <p>Suspended Accounts</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ trial_conversion_rate }}%</h3>
            <p>Trial Conversion Rate</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ total_admin_users|intcomma }}</h3>
            <p>Total Admin Users</p>
            <div class="trend">+2.1% <a href="#" style="color: #10B981; text-decoration: none;">View Details</a></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h3>{{ churn_risk|intcomma }}</h3>
            <p>Churn Risk</p>
            <div class="trend" style="color: #EF4444;">Companies flagged</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Revenue Overview -->
    <div class="col-md-8">
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5 style="margin: 0; font-weight: 600;">Revenue Overview</h5>
                <div style="display: flex; gap: 12px;">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>All Departments</option>
                    </select>
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>September</option>
                    </select>
                </div>
            </div>
            <p style="font-size: 12px; color: #6B7280; margin-bottom: 20px;">Last Updated at 11:30PM</p>
            <canvas id="revenueChart" height="100"></canvas>
        </div>
    </div>

    <!-- Plan Distribution -->
    <div class="col-md-4">
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5 style="margin: 0; font-weight: 600;">Plan Distribution</h5>
                <select class="form-select form-select-sm" style="width: auto;">
                    <option>Today</option>
                </select>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 24px; font-weight: 700;">Active subscriptions by plan: 120</div>
            </div>
            <div>
                {% for plan in plan_distribution|slice:":4" %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #F3F4F6;">
                    <span>{{ plan.plan__name|default:"Unknown" }}</span>
                    <span style="font-weight: 600;">{{ plan.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Recent Activity -->
    <div class="col-md-6">
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5 style="margin: 0; font-weight: 600;">Recent Activity</h5>
                <div style="display: flex; gap: 12px;">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>All Activity</option>
                    </select>
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>Today</option>
                    </select>
                </div>
            </div>
            <div>
                {% for activity in recent_activity|slice:":5" %}
                <div class="activity-item">
                    <div style="font-size: 14px; color: #111827;">
                        New company registered. <strong>{{ activity.tenant.name }}</strong> started a 14-day trial
                    </div>
                    <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">{{ activity.created_at|timesince }}
                        ago</div>
                </div>
                {% empty %}
                <div class="activity-item">
                    <div style="font-size: 14px; color: #6B7280;">No recent activity</div>
                </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 16px;">
                <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
        </div>
    </div>

    <!-- Upcoming Renewals -->
    <div class="col-md-6">
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h5 style="margin: 0; font-weight: 600;">Upcoming Renewals</h5>
                <div style="display: flex; gap: 12px;">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>All Renewals</option>
                    </select>
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>Today</option>
                    </select>
                </div>
            </div>
            <div>
                {% for renewal in upcoming_renewals|slice:":5" %}
                <div class="activity-item">
                    <div style="font-size: 14px; color: #111827;">
                        <strong>{{ renewal.tenant.name }}</strong>, {{ renewal.plan.name }}
                    </div>
                    <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">
                        ₹{{ renewal.amount|floatformat:0|intcomma }} • {{ renewal.end_date|timeuntil }} left
                    </div>
                </div>
                {% empty %}
                <div class="activity-item">
                    <div style="font-size: 14px; color: #6B7280;">No upcoming renewals</div>
                </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 16px;">
                <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Simple revenue chart (using canvas)
    const ctx = document.getElementById('revenueChart');
    if (ctx) {
        const revenueData = {{ revenue_data| safe
    }};
    // Simple bar chart implementation would go here
    // For now, just a placeholder
    console.log('Revenue data:', revenueData);
    }
</script>
{% endblock %}